const fs = require('fs');
const path = require('path');

// 修复映射表 - 将截断的字符修复为完整的中文
const fixMap = {
  '确保安�?': '确保安全',
  '寻找创新的解决方�?': '寻找创新的解决方案',
  '与他人协作共同应�?': '与他人协作共同应对',
  '维护稳定和和�?': '维护稳定和和谐',
  '探索未知和创�?': '探索未知和创新',
  '什么最能激发你的内在动力�?': '什么最能激发你的内在动力？',
  '当你设定目标时，什么因素最重要�?': '当你设定目标时，什么因素最重要？',
  '目标的挑战性和成就�?': '目标的挑战性和成就感',
  '目标的可实现性和安全�?': '目标的可实现性和安全性',
  '目标的创新性和突破�?': '目标的创新性和突破性',
  '个人能力的提�?': '个人能力的提升',
  '团队的和谐合�?': '团队的和谐合作',
  '创新思维的发�?': '创新思维的发展',
  '人际关系的建�?': '人际关系的建立',
  '超越他人，达到顶�?': '超越他人，达到顶峰',
  '内心平静，生活稳�?': '内心平静，生活稳定',
  '不断创新，突破自�?': '不断创新，突破自我',
  '帮助他人，共同成�?': '帮助他人，共同成长',
  '分析原因，重新挑�?': '分析原因，重新挑战',
  '接受现实，寻求稳�?': '接受现实，寻求稳定',
  '寻求支持，共同面�?': '寻求支持，共同面对',
  '逻辑分析和数�?': '逻辑分析和数据',
  '直觉和感�?': '直觉和感受',
  '过往经验和传�?': '过往经验和传统',
  '个人成就和地�?': '个人成就和地位',
  '安全感和稳定�?': '安全感和稳定性',
  '自由和独立�?': '自由和独立性',
  '人际关系和连�?': '人际关系和连接',
  '和谐稳定的协作环�?': '和谐稳定的协作环境',
  '自由开放的创新环境': '自由开放的创新环境',
  '温暖支持的社交环�?': '温暖支持的社交环境',
  '积极行动，创造机�?': '积极行动，创造机会',
  '谨慎观察，等待时�?': '谨慎观察，等待时机',
  '灵活应变，随机应�?': '灵活应变，随机应对',
  '寻求指导，降低风�?': '寻求指导，降低风险',
  '拥抱变化，寻求突�?': '拥抱变化，寻求突破',
  '适应变化，保持稳�?': '适应变化，保持稳定',
  '引导变化，创新发�?': '引导变化，创新发展',
  '理解变化，寻求平�?': '理解变化，寻求平衡',
  '在压力下，你的反应是�?': '在压力下，你的反应是？',
  '迎接挑战，证明自�?': '迎接挑战，证明自己',
  '寻求支持，共同应�?': '寻求支持，共同应对',
  '深入分析，理性应�?': '深入分析，理性应对',
  '主动交流，建立联�?': '主动交流，建立联系',
  '分享想法，启发他�?': '分享想法，启发他人',
  '深度倾听，理解他�?': '深度倾听，理解他人',
  '相互支持和理�?': '相互支持和理解',
  '思想碰撞和启�?': '思想碰撞和启发',
  '情感共鸣和陪�?': '情感共鸣和陪伴',
  '团队成员的感受和需�?': '团队成员的感受和需求',
  '立即行动，解决问�?': '立即行动，解决问题',
  '创新思考，寻找新方�?': '创新思考，寻找新方法',
  '相互理解，和谐共�?': '相互理解，和谐共处',
  '思想交流，启发创�?': '思想交流，启发创新',
  '情感连接，深度陪�?': '情感连接，深度陪伴',
  '在处理人际冲突时，你的方式是�?': '在处理人际冲突时，你的方式是？',
  '寻求妥协，维护关�?': '寻求妥协，维护关系',
  '化解矛�?': '化解矛盾',
  '深入理解，寻求共�?': '深入理解，寻求共识',
  '思想的自�?': '思想的自由',
  '行动的自�?': '行动的自由',
  '选择的自�?': '选择的自由',
  '灵活的工作方�?': '灵活的工作方式',
  '创新的工作内�?': '创新的工作内容',
  '和谐的工作环�?': '和谐的工作环境',
  '严格遵守，维护秩�?': '严格遵守，维护秩序',
  '创新改进，优化效�?': '创新改进，优化效果',
  '理解本质，寻求平�?': '理解本质，寻求平衡',
  '系统学习，循序渐�?': '系统学习，循序渐进',
  '自主探索，灵活学�?': '自主探索，灵活学习',
  '创新实践，边做边�?': '创新实践，边做边学',
  '你理想的生活状态是�?': '你理想的生活状态是？',
  '充满挑战，不断突�?': '充满挑战，不断突破',
  '随心所�?': '随心所欲',
  '创新创造，实现价�?': '创新创造，实现价值',
  '平衡和谐，内心宁�?': '平衡和谐，内心宁静',
  '尊重权威，服从指�?': '尊重权威，服从指导',
  '保持独立，理性判�?': '保持独立，理性判断',
  '挑战权威，寻求创�?': '挑战权威，寻求创新',
  '理解权威，寻求合�?': '理解权威，寻求合作',
  '追求卓越，超越自�?': '追求卓越，超越自我',
  '和谐稳定，内心平�?': '和谐稳定，内心平静',
  '创新变革，引领潮�?': '创新变革，引领潮流',
  '自由独立，真实自�?': '自由独立，真实自我',
  '成就事业，获得认�?': '成就事业，获得认可',
  '稳定生活，内心安�?': '稳定生活，内心安宁',
  '情感连接，温暖他�?': '情感连接，温暖他人',
  '在人生的十字路口，你如何选择�?': '在人生的十字路口，你如何选择？',
  '选择最灵活自由的道�?': '选择最灵活自由的道路',
  '选择最温暖人心的道�?': '选择最温暖人心的道路',
  '你希望别人如何记住你�?': '你希望别人如何记住你？',
  '一个成功的领导�?': '一个成功的领导者',
  '一个创新的思想�?': '一个创新的思想家',
  '在团队中，你通常扮演什么角色�?': '在团队中，你通常扮演什么角色？',
  '主动承担领导责任': '主动承担领导责任',
  '提供支持和帮�?': '提供支持和帮助',
  '激发团队活�?': '激发团队活力',
  '避免冲突，维护和�?': '避免冲突，维护和谐',
  '寻找创新的解决方�?': '寻找创新的解决方案',
  '倾听各方，寻求共�?': '倾听各方，寻求共识',
  '在工作中，你更喜欢如何与他人互动�?': '在工作中，你更喜欢如何与他人互动？',
  '指导和引领他�?': '指导和引领他人',
  '协作和支持他�?': '协作和支持他人',
  '启发和激励他�?': '启发和激励他人',
  '深度交流和分�?': '深度交流和分享',
  // 新增的编码错误模式
  '和和�?': '和谐',
  '成就感�?': '成就感',
  '在追求成功的过程中，你最看重什么�?': '在追求成功的过程中，你最看重什么？',
  '面对挫折时，你的态度是�?': '面对挫折时，你的态度是？',
  '在做决策时，你主要依靠什么�?': '在做决策时，你主要依靠什么？',
  '什么样的环境让你感到最舒适�?': '什么样的环境让你感到最舒适？',
  '面对不确定性，你的策略是�?': '面对不确定性，你的策略是？',
  '对于变化，你的态度是�?': '对于变化，你的态度是？',
  '在与他人交流时，你最重视什么�?': '在与他人交流时，你最重视什么？',
  '你认为团队合作中最重要的是什么�?': '你认为团队合作中最重要的是什么？',
  '在团队讨论中，你通常如何参与�?': '在团队讨论中，你通常如何参与？',
  '当团队出现分歧时，你会如何处理�?': '当团队出现分歧时，你会如何处理？',
  '你最看重工作中的哪个方面�?': '你最看重工作中的哪个方面？',
  '对于规则和制度，你的态度是�?': '对于规则和制度，你的态度是？',
  '你更喜欢哪种学习方式�?': '你更喜欢哪种学习方式？',
  '对于人生目标，你更倾向于�?': '对于人生目标，你更倾向于？',
  '对于权威，你的态度是�?': '对于权威，你的态度是？'
};

function fixCsvEncoding() {
  const csvPath = path.join(__dirname, 'public', 'extended_question_bank.csv');
  
  try {
    // 读取CSV文件
    let content = fs.readFileSync(csvPath, 'utf8');
    console.log('原始文件大小:', content.length);
    
    // 应用修复映射
    let fixedCount = 0;
    for (const [broken, fixed] of Object.entries(fixMap)) {
      const regex = new RegExp(broken.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      const matches = content.match(regex);
      if (matches) {
        content = content.replace(regex, fixed);
        fixedCount += matches.length;
        console.log(`修复: "${broken}" -> "${fixed}" (${matches.length}次)`);
      }
    }
    
    // 额外的通用修复模式
    // 修复以�?结尾的字符
    content = content.replace(/([\u4e00-\u9fff]+)�\?/g, '$1？');
    content = content.replace(/([\u4e00-\u9fff]+)�\./g, '$1。');
    content = content.replace(/([\u4e00-\u9fff]+)�\,/g, '$1，');
    content = content.replace(/([\u4e00-\u9fff]+)�/g, '$1');
    
    // 写回文件
    fs.writeFileSync(csvPath, content, 'utf8');
    
    console.log(`\n修复完成！`);
    console.log(`总共修复了 ${fixedCount} 个字符编码问题`);
    console.log(`修复后文件大小: ${content.length}`);
    
  } catch (error) {
    console.error('修复过程中出错:', error);
  }
}

// 运行修复
fixCsvEncoding();